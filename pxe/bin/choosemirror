#!/bin/sh
# backuPXE - Copyright (C) 2006-2019 Luc Deschenaux
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# usage: choosemirror [ ftp | http [ <mirrors_list_url> | <mirror_url> ] ]
#
# this script allows selection of a http or ftp mirror using slackware.org
# official list of mirror that is normalized (thanks !)
#
# the server name is held in /etc/slackware-mirror

# 29.03.2006 initial release

TEMP=$ROOT/tmp/choosemirror.$$.tmp

if [ -z "$SOURCE" ] ; then
  SOURCE=slackware
fi

doexit () {
  cd
  echo  rm -rf $TEMP 2> /dev/null
  exit $1 ;
}

# command line arguments

TYPE="$1"

if [ -z "$2" ] ; then

  case $SOURCE in
    slackware)
      URL=http://www.slackware.org/getslack ;;
    linuxpackages)
      URL=http://www.linuxpackages.net/mirrors.php ;;
    default)
      exit 1 ;;
  esac

else

  URL="$2"

fi

if [ "$TYPE" != "" -a "$TYPE" != "ftp" -a "$TYPE" != "http" ] ; then
  echo 'usage: choosemirror [ ftp | http [ <mirrors_list_url> | other ] ]'
  echo
  doexit 1
fi

# creating temporary folder
mkdir -p $TEMP
if [ $? -ne 0 ] ; then
  dialog --msgbox "Cannot make dir $TEMP 0 0
  doexit 1
fi

cd $TEMP
if [ $? -ne 0 ] ; then
  dialog --msgbox "Cannot change to dir $TEMP 0 0
  doexit 1
fi

# download mirror location list
dialog --infobox "Downloading $URL" 6 60
wget -q $URL -O $TEMP/index.html
if [ $? -ne 0 ] ; then
   dialog --msgbox "$URL: Download Failed" 0 0 2> /dev/null
   radiolist='"Use another mirror" "" on '$radiolist
fi

# selecting a transfer protocol if none specified
if [ -z "$TYPE" ] ; then
  dialog --radiolist "Select a transfer protocol" 0 0 0 http "" on ftp "" off 2> $TEMP/protocol
  if [ $? -ne 0 ] ; then
     echo http > $TEMP/protocol
  fi
  TYPE=`cat $TEMP/protocol`
fi

# creating mirror location radiolist
if [ -z "$radiolist" ] ; then
  case "$SOURCE" in
    slackware)
      radiolist=`sed -r -n -e 's/.*?country=([^" ]+).*/\1 \"\" off/p' $TEMP/index.html` ;;
    linuxpackages)
      radiolist=`sed -r -n  -e 's/REPOS_ROOT=([^%]+)%('$TYPE'[^\<]+).*/\2 \"\1\" off/p' $TEMP/index.html` ;;
#REPOS_ROOT=Telecoms%http://linuxpackages.telecoms.bg/Slackware-xx/<br>

  esac
  if [ -z "$radiolist" ] ; then
     dialog --msgbox "Parsing of mirror list failed !"
     echo $TEMP/index.html
     exit 1
  fi
  radiolist='"Use another mirror" "" on '$radiolist
fi

while true ; do
	# selecting mirror location or
	eval dialog --radiolist Please\\ select\\ a\\ location 0 0 0 $radiolist 2> $TEMP/location
	if [ $? -ne 0 ] ; then
	   dialog --msgbox `cat $TEMP/location` 0 0 2> /dev/null
	   doexit 1
	fi

	# specifying a custom server address instead
	if [ "`cat $TEMP/location`" = "Use another mirror" ] ; then
	  dialog --inputbox "Enter a custom $TYPE url" 0 50 "$TYPE://" 2> $TEMP/customurl
	  if [ $? -eq 0 ] ; then
	#### storing mirror address
	     mkdir -p $ROOT/etc || doexit 1
	     cat $TEMP/customurl > $ROOT/etc/$SOURCE-mirror
	     choosesubdir || doexit 1
	     doexit 0
	  fi
	  continue
	else
	  break
	fi
done

case "$SOURCE" in

  slackware)
# downloading the server list
    country=`cat $TEMP/location`
    dialog --infobox "Downloading $URL/list.php?country=$country" 6 70
    wget -q $URL/list.php?country=$country -O $TEMP/$country
    if [ $? -ne 0 ] ; then
       dialog --msgbox "$URL/list.php?country=$country: Download Failed" 6 70
       doexit 1
    fi

    # creating the server list radiolist
    err=0
    radiolist=`sed -r -n -e 's/.*<TD><A HREF="('$TYPE':\/\/[^"]+).*/\1 "'$country'" off/p' $TEMP/$country || err=\$?`
    if [ -z "$radiolist" ] ; then
      if [ $err -ne 0 ] ; then
        dialog --msgbox "Theres no $TYPE $SOURCE mirror in $country (or parsing the server list failed) !\nTry another protocol or location." 9 70
        doexit 1
      else
        dialog --msgbox "Parsing the server list failed: `cat err`" 6 70
        echo $TEMP/$country
        exit 1
      fi
    fi

    # selecting a server in the list
    eval dialog --radiolist Please\\ select\\ a\\ mirror\\ in\\ your\\ area 0 0 0 $radiolist 2> $TEMP/mirror
    if [ $? -ne 0 ] ; then
       doexit 1
    fi ;;

  linuxpackages)
    mv $TEMP/location $TEMP/mirror ;;

esac

#### storing mirror address
if [ -f $TEMP/mirror ] ; then
  mkdir -p $ROOT/etc || doexit 1
  cat $TEMP/mirror > $ROOT/etc/$SOURCE-mirror || doexit 1
  choosesubdir || doexit 1
fi

doexit 0
